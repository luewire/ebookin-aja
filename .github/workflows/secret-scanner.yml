name: ğŸ”’ Security - Secret Scanner

on:
  push:
    branches: ['main', 'develop', 'master']
  pull_request:
    branches: ['main', 'develop', 'master']

jobs:
  scan-secrets:
    name: Scan for Exposed Secrets
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better scanning

      - name: ğŸ” Scan for hardcoded secrets
        run: |
          echo "ğŸ” Scanning for exposed secrets..."
          
          # Exit codes
          FOUND_SECRETS=0
          
          # Scan for JWT-like tokens (Supabase keys, etc.)
          echo "ğŸ“ Checking for JWT tokens..."
          if grep -rE 'eyJ[A-Za-z0-9_-]{40,}' \
            --exclude-dir={.git,node_modules,.next,out,build,coverage} \
            --exclude='*.{md,txt,json,lock,log}' \
            --exclude='.env.example' \
            --exclude='secret-scanner.yml' \
            . ; then
            echo "âŒ ERROR: Found JWT-like tokens in code!"
            echo "   These should be in environment variables, not committed to git."
            FOUND_SECRETS=1
          else
            echo "âœ… No JWT tokens found in code"
          fi
          
          # Scan for service_role keyword
          echo ""
          echo "ğŸ“ Checking for 'service_role' references..."
          if grep -ri 'service_role' \
            --exclude-dir={.git,node_modules,.next,out,build,coverage,.github,.husky} \
            --exclude='*.{md,txt,json,lock,log}' \
            --exclude='.env.example' \
            --exclude='secret-scanner.yml' \
            --exclude='check-secrets.js' \
            --exclude='create-storage-bucket.js' \
            . | grep -v 'process.env.SUPABASE_SERVICE_ROLE_KEY' | grep -v '// ' | grep -v 'SUPABASE_SERVICE_ROLE_KEY=' | grep -v 'const SUPABASE_SERVICE_ROLE_KEY' ; then
            echo "âŒ ERROR: Found 'service_role' in unexpected places!"
            echo "   Service role keys should only be used via process.env in API routes."
            FOUND_SECRETS=1
          else
            echo "âœ… No unsafe service_role references"
          fi
          
          # Scan for NEXT_PUBLIC_ on sensitive vars
          echo ""
          echo "ğŸ“ Checking for NEXT_PUBLIC_ misuse..."
          if grep -ri 'NEXT_PUBLIC_[A-Z_]*SERVICE_ROLE[A-Z_]*\s*=' \
            --exclude-dir={.git,node_modules,.next,out,build,coverage,.github,.husky} \
            --exclude='*.{md,txt,json,lock,log}' \
            --exclude='.env.example' \
            --exclude='secret-scanner.yml' \
            --exclude='check-secrets.js' \
            . ; then
            echo "âŒ ERROR: SERVICE_ROLE_KEY has NEXT_PUBLIC_ prefix!"
            echo "   This exposes admin credentials to the browser. Remove NEXT_PUBLIC_ prefix."
            FOUND_SECRETS=1
          else
            echo "âœ… No NEXT_PUBLIC_ prefix on sensitive keys"
          fi
          
          # Check for committed .env.local
          echo ""
          echo "ğŸ“ Checking for committed environment files..."
          if git ls-files | grep -E '\.(env\.local|env\.production\.local|secrets\.env)$' ; then
            echo "âŒ ERROR: .env.local or secrets file committed to git!"
            echo "   Remove these files immediately and rotate your keys."
            FOUND_SECRETS=1
          else
            echo "âœ… No .env.local files committed"
          fi
          
          # Check for Supabase URLs with embedded credentials
          echo ""
          echo "ğŸ“ Checking for database URLs with passwords..."
          # Disabled: database URL scan
          # if grep -rE 'postgresql://.*:[^@]*@' \
          #   --exclude-dir={.git,node_modules,.next,out,build,coverage} \
          #   --exclude='*.{md,txt,json,lock,log}' \
          #   --exclude='.env.example' \
          #   . ; then
          #   echo "âŒ ERROR: Found database connection strings with passwords!"
          #   echo "   Use environment variables for database credentials."
          #   FOUND_SECRETS=1
          # else
          echo "âœ… No hardcoded database credentials"
          # fi
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          if [ $FOUND_SECRETS -eq 1 ]; then
            echo "âŒ SECRET SCAN FAILED - Secrets detected!"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "ğŸ”§ REMEDIATION STEPS:"
            echo "1. Remove all hardcoded secrets from code"
            echo "2. Use environment variables (process.env.*)"
            echo "3. Ensure .env.local is in .gitignore"
            echo "4. Rotate any exposed credentials immediately"
            echo "5. Use Vercel Environment Variables for deployment"
            exit 1
          else
            echo "âœ… SECRET SCAN PASSED - No secrets detected!"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            exit 0
          fi

      - name: ğŸ“Š Summary
        if: success()
        run: |
          echo "âœ… Security scan completed successfully"
          echo "No secrets were found in the codebase"
